{% extends "auctions/layout.html" %}

{% block body %}

<h1>{{ auction.title }}</h1>
{% if auction.image_url %}
    <img src="{{ auction.image_url }}" alt="{{ auction.title }}" 
        class="img-fluid rounded-top"
    />
{% endif %}
  
<p>Starting Bid: ${{ auction.starting_bid }}</p>
<p>Current Bid: {% if current_bid %}${{ current_bid.value }}, {{ current_bid.bidder }} {% else %}No bids yet{% endif %}</p>
<p>Description: {{ auction.description }}</p>

{% if user.is_authenticated %}
<form action="{% url 'toggle_watchlist' auction.id %}" method="post" style="margin-bottom: 20px;">
    {% csrf_token %}
    {% if auction in user.watchlist.all %}
        <button type="submit" class="btn btn-warning">Remove from Watchlist</button>
    {% else %}
        <button type="submit" class="btn btn-success">Add to Watchlist</button>
    {% endif %}
</form>
{% endif %}

  <form  action="{% url 'make_bid' auction.id %}" method="post" style="margin-bottom: 50px;">
        {% csrf_token %}
        <p>{{ auction.bids.count }} bid(s) so far.</p>
        {% if user.is_authenticated and auction.is_active and request.user != auction.seller  %}
        <div class="form-group">
            <input type="number" class="form-control" id="value" name="value" step="0.01" min="{% if current_bid %}{{ current_bid.value }}{% else %}{{ auction.starting_bid }}{% endif %}" required placeholder="Bid">
        </div>
        <button type="submit" class="btn btn-primary">Place Bid!</button>
        {% elif not user.is_authenticated %}
            <p>Please <a href="{% url 'login' %}">login</a> to place a bid.</p>
        {% else %} 

            <p>This auction is closed!</p>
            {% if not auction.is_active and user.is_authenticated and current_bid and user.username == current_bid.bidder %}
                <strong>Congratulations! You won the auction!</strong>
            {% else %}
                <p>The winner is: <strong>{{ current_bid.bidder }}</strong></p>
            {% endif %}
           
        {% endif %}
    </form>

    <div style="margin-bottom: 50px;">
        <h1>Details</h1>
        <ul>
            <li>Listed by: {{ auction.seller }}</li>
            <li>Category: {{ auction.category }}</li>
        </ul>
    </div>

  

    <div style="margin-bottom: 50px;">
        <h1>Comment Section</h1>
        {% if user.is_authenticated %}
        <form action="{% url 'post_comment' auction.id %}" method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="text">Comment:</label>
                <textarea class="form-control" id="text" name="text" rows="4" required></textarea>
            </div>
            <input class="btn btn-primary" type="submit" value="Comment">
        {% else %}
            <p>Please <a href="{% url 'login' %}">login</a> to comment.</p>
        {% endif %}
        </form>
    </div>


    <div style="margin-bottom: 50px;">
        <h3>Comments</h3>
            {% if comments %}
                <ul>
                    {% for comment in comments %}
                    <li>
                        <h4>{{ comment.author }}</h4><br>
                        <p>{{ comment.text }}</p><br>
                        <p>{{ comment.timestamp }}</p>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No comments yet</p>
            {% endif %}
    </div>

    <div>
        {% if request.user == auction.seller and auction.is_active %}
        <form action="{% url 'close_auction' auction.id %}" method="post">
            {% csrf_token %}
            <button class="btn btn-warning" type="submit">Close this Auction!</button>
        </form>
        {% endif %}
    </div>

   
{% endblock %}